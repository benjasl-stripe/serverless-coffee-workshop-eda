+++
title = "Workflow Started"
weight = 14
+++
## Overview

The `WorkflowStarted` event is emitted by the Order processor workflow built in module 1. At this point in the order, the workflow has checked that the shop is open and that there is capacity to serve a new order (not too many unfulfilled orders). The workflow now waits for up to 5 minutes for the customer to choose and submit their coffee order. This is the first time in the process that the order waits for a human action.  

AWS Step functions does this by implementing the *Wait for callback Task Token* patern. Step Functions passes the task token to the integrated service ([Amazon EventBridge](https://aws.amazon.com/eventbridge)). The task pauses until the workflow receives that task token back with a `SendTaskSuccess` or `SendTaskFailure` call.

In the next step you create the rule that recieves the `WorkflowStarted` event containing the task token. You route this event to an [AWS Lambda Function](https://aws.amazon.com/lambda/) which persists the token to an [AWS DynamoDB](https://aws.amazon.com/dynamodb/) table, along with the unique order id.

![Execution results](../images/se-mod2-WorkflowStarted3.png)


* You will create a new rule in [Amazon EventBridge](https://aws.amazon.com/eventbridge/).
* You will congifure the new rule to invoke an [AWS Lambda Function](https://aws.amazon.com/lambda/).
* You will test the new rule and see the Lambda function inuput payload and response.

## Creating the Workflow Started rule.
### Step-by-step instructions ##

1. Go to the EventBridge console. From the AWS Management Console, select *Services* then select EventBridge  *Application Integration*. **Make sure your region is correct**.

2. Choose **Rules**.

3. Choose the event bus named **servelresspresso**.

4. Choose **Create rule**.

5. For the Name, enter *WorkflowStarted*.

6. Choose **Custom pattern**.

7. Copy-and-paste the following into the Event Pattern section:
```
{
  "detail-type": ["OrderProcessor.WorkflowStarted"],
  "source": ["awsserverlessda.serverlesspresso"]
}
```

8. Choose **save**.

9. In the *Select targets* section, choose the *WorkflowStarted* Lambda function from the *Function* dropdown. You can start typing "WorkflowStarted" into field to find the function.

10. Choose **Create**.

--------------------------------

## Testing the *"WorkflowStarted"* EventBridge rule.

In this section, you will test that the rule invoked the *WorkflowStarted* Lambda function, and inspect the event payload and results.

### Step-by-step instructions ###

To start a new workflow:

1. From the [AWS Cloud 9](https://console.aws.amazon.com/cloud9) terminal run the following AWS CLI command which will emit the `NewOrder` event to the `serverlesspresso` event bus that starts the `OrderProcessor` workflow:
```
aws events put-events --entries '[{"Source":"awsserverlessda.serverlesspresso", "DetailType":"Validator.NewOrder", "EventBusName":"Serverlesspresso", "Detail": "{\"userId\":\"1\",\"orderId\":\"1\"}"}]'

``` 

The `OrderProcessor` workflow should already be running, and the `WorkflowStarted` event should have been sent to the *Serverlesspresso event bus*. 

1. check this by looking at the [/aws/events/serverlesspressoEventBus](https://console.aws.amazon.com/cloudwatch/home?#logsV2:log-groups/log-group/$252Faws$252Fevents$252FserverlesspressoEventBus) CloudWatch Log group created in Part 1 of this module. 

1. Choose the most recent *Log Stream* and choose the arrow next to the *Timestamp* column.

![Execution results](../images/se-mod2-logAll2.png)

This shows all event information, including the `TaskToken` generated by AWS Step Functions, the event `detail-type`, and the event `source`.  

1. The new *WorkflowStarted* rule should have already routed this event to the *WorkflowStarted* Lambda function, which in turn will have percisted it to the a DynamoDB table named *serverlesspresso-order-table*.

1. Go to the [serverlesspresso-order-table](https://console.aws.amazon.com/dynamodbv2/home?#item-explorer?initialTagKey=&maximize=true&table=serverlesspresso-order-table).

1. Choose **Orders** from the *PK* column. 
![Execution results](../images/se-mod2-workflowStarted1.png)

The order was persisted to DynamoDB, along with the Step Functions Task Token, the Order id (SK), and the the *ORDERSTATE*:

![Execution results](../images/se-mod2-workflowStarted2.png)

The Task token will be retrieved from here when the customer submits their order. It will then be use to resume the workflow.

----------------------------------
