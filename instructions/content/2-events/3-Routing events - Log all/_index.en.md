+++
title = "Log All"
weight = 12
+++
## Overview

* You will create a new rule in [Amazon EventBridge](https://aws.amazon.com/eventbridge/).
* You will test the new rule and see the input payloads.
* You will configure the new rule to log all events to [Amazon CloudWatch Logs](https://aws.amazon.com/cloudwatch/).

Each serverlesspresso event is emitted to a custom event bus named *"Serverlesspresso"*.

An event is a change in state, or an update, like an order being placed on the customer website. Events can either carry the state (the item ordered, its modifiers, and user id) or events can be identifiers (a notification that an order was completed).

Event-driven architectures have three key components: event producers, event routers, and event consumers. A producer publishes an event to the router, which filters and pushes the events to consumers. Producer services and consumer services are decoupled, which allows them to be scaled, updated, and deployed independently.

Events are ephemeral in nature, meaning that they are not stored when recieved. It's often useful to log events and their state for later inspection and playback.

## Creating the "Log All" rule

Create a rule that logs every event through the application's custom bus to CloudWatch Logs.

### Step-by-step instructions ##

1. Go to the EventBridge console. From the AWS Management Console, select *Services* then select EventBridge  *Application Integration*. **Make sure your region is correct**.

2. Choose **Rules**.

![Rules menu](../images/se-mod2-logAll3.png)

3. Choose the event bus named **Serverlesspresso**.

![Rules menu](../images/se-mod2-logAll4.png)

4. Choose **Create rule**. For the Name, enter *logAll*.

![Create rule and add name](../images/se-mod2-logAll5.png)

5. In the *Define pattern* panel, choose **Custom pattern**. Paste the following into the *Event Pattern* section and choose **Save**.
```
{
  "source": ["awsserverlessda.serverlesspresso"]
}
```

![Custom pattern](../images/se-mod2-logAll6.png)

6. In the *Select targets* panel, choose *CloudWatch log group*

7. In the *Log Group* field, enter  **serverlesspressoEventBus**.

![Select targets panel](../images/se-mod2-logAll7.png)

8. Choose **Create**.

## Testing the "Log All" EventBridge rule

In this section, you will test that the rule logs all Serverlesspresso events to the correct log group. You use the Step Function workflow from module 1 to generate the events.

### Step-by-step instructions ###

1. From the [AWS Step Functions console] (https://console.aws.amazon.com/states/), select the *OrderProcessorWorkflow* you created earlier.

2. From the section at top of the the page showing the workflow, choose **Start execution**.

![Start execution](../images/se-mod2-logAll8.png)

2. In the *Start execution* pop-up, enter the following JSON payload in the *Input* textbox, then choose **Start execution**:

```
{
    "detail": {
      "orderId": "2",
      "userId": "testuser2"
    }
}
```

3. The console shows the *Execution status* of *Running*. The left side shows the flow of execution with the green states showing the actual path. The blue state shows when execution is suspended, pending a callback.

![Execution results](../images/se-mod1-wait11.png)

4. In the *Execution event history* panel, open the *TaskScheduled* event for *Emit - Awaiting completion TT*. This displays the payload for this event. The event detail information is also displayed here. It contains:
  * The name of the event bus *EventBusName* that the event is emitted to (`serverlesspresso`).
  * The event *Source* (`awsserverlessda.serverlesspresso`).
  * The event `DetailType` (`OrderProcessor.WorkflowStarted`).

![Execution results](../images/se-mod2-logAll.png)

Since this event is emitted to the `Serverlesspresso` event bus and contains the source `awsserverlessda.serverlesspresso`, it is routed to CloudWatch Logs by the rule you  created.

5. Go to the [CloudWatch console](https://console.aws.amazon.com/cloudwatch/home). From the AWS Management Console, select *Services* then select CloudWatch in *Management & Governance*. **Make sure your region is correct**.

6. From the left menu, choose **Log groups**. Choose the log group called `/aws/events/serverlesspressoEventBus`.

![Execution results](../images/se-mod2-logAll9.png)

8. Each event is logged to a separate log stream. Choose the first log stream.

9. From the *Target(s)* section, choose the target named **severlesspressoEventBus**, then choose first row in the *Log Stream* section. Expand the arrow next to the timestamp.

![Execution results](../images/se-mod2-logAll2.png)

This shows all event information, including the `TaskToken` generated by Step Functions, the event `detail-type`, and the event `source`.

From now on, any event that is emitted to the `Serverlesspresso` custom event bus will be sent to CloudWatch Logs and available for inspection.
