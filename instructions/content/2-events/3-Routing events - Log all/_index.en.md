+++
title = "Log All"
weight = 12
+++
## Overview

* You will create a new rule in [Amazon EventBridge](https://aws.amazon.com/eventbridge/).
* You will test the new rule and see the input payloads.
* You will congifure the new rule to log all events to [Amazon CloudWatch Logs](https://aws.amazon.com/cloudwatch/).

Each serverlesspresso event is emitted to a custom event bus named *"Serverlesspresso"*. 
An event is a change in state, or an update, like an order being placed on the customer website. Events can either carry the state (the item ordered, its modifiers, and user id) or events can be identifiers (a notification that an order was completed).

Event-driven architectures have three key components: event producers, event routers, and event consumers. A producer publishes an event to the router, which filters and pushes the events to consumers. Producer services and consumer services are decoupled, which allows them to be scaled, updated, and deployed independently.

Events are ephemeral in nature, meaning that they are not stored when recieved. It's often usefuk to log events, and their state. for later inspection and playback.  


## Creating the "Log All" rule.
### Step-by-step instructions ##

1. Go to the EventBridge console. From the AWS Management Console, select *Services* then select EventBridge  *Application Integration*. **Make sure your region is correct**.

2. Choose **Rules**.

3. Choose the event bus named **serverlesspresso**.

4. Choose **Create rule**.

5. For the Name, enter *logAll*.

6. Choose **Custom pattern**.

7. Copy-and-paste the following into the Event Pattern section:
```
{
  "source": ["awsserverlessda.serverlesspresso"]
}
```

8. Choose **save**.

9. In the *Select targets* section, choose *CloudWatch log group* 

10. In the *Log Group* field, enter  **serverlesspressoEventBus**.

10. Choose **Create**.

## Testing the *"Log All"* EventBridge rule.

In this section, you will test that the rule logs all serverlesspresso events to the correct log group.

### Step-by-step instructions ###

1. From the [AWS Step Functions console](https://us-east-2.console.aws.amazon.com/states/home?#/statemachines) select the *OrderProcessorWorkflow* you created earlier.

2. From the section at top of the the page showing the workflow, choose **Start execution**.

2. In the *Start execution* pop-up, enter the following JSON payload, then choose **Start execution**:

```
{
    "detail": {
      "orderId": "1",
      "userId": "testuser"
    }
}
```

3. The console shows the *Execution status* of *Running*. The left side shows the flow of execution with the green states showing the actual path. The blue state shows when executed is suspended, pending a callback.

![Execution results](../images/se-mod1-wait11.png)

4. In the *Execution event history* panel, open the *TaskScheduled* event for *Emit - Awaiting completion TT*. This displays the payload for this event.  The event detail information is also displayed here.  It contains: 
  * The name of the event bus *EventBusName*, that the event is emitted to, `serverlesspresso`.
  * The event *Source*, `awsserverlessda.serverlesspresso`.
  * The event `DetailType`, `OrderProcessor.WorkflowStarted`

![Execution results](../images/se-mod2-logAll.png)

Since this event is emitted to the `serverlesspress` event bus and contains the source `awsserverlessda.serverlesspresso`, it should have been routed to CloudWatch Logs by the rule you previously created. 

5. Go to the EventBridge console. From the AWS Management Console, select *Services* then select EventBridge  *Application Integration*. **Make sure your region is correct**.

6. Choose **Rules**.

7. Choose the event bus named **serverlesspresso**.

8. Choose the rule named **LogAll**.

9. From the *Target(s)* section, choose the target named **severlesspressoEventBus**, then choose first row in the *Log Stream* section.

10. Choose the Arrow next to the Timestamp.

![Execution results](../images/se-mod2-logAll2.png)

This shows all event information, including the `TaskToken` generated by AWS Step Functions, the event `detail-type`, and the event `source`.  


From now on, any event that is emitted to the `serverlesspresso` custom event bus will be sent to CloudWatch Logs and available for inspection.